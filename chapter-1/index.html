<script>
(function(){
  const DIR = "images/";
  const TOTAL = 12; // 1 cover + 11 pages

  const pagesEl = document.getElementById("pages");
  for (let i = 1; i <= TOTAL; i++) {
    const p = document.createElement("div");
    p.className = "page";
    p.dataset.page = i;

    // FILE NAME LOGIC
    const filename = i === 1 
      ? "CH1.jpg" 
      : `CH1_${String(i - 1).padStart(2, "0")}.jpg`;

    const img = document.createElement("img");
    img.alt = `Page ${i}`;
    img.loading = "lazy";
    img.decoding = "async";
    img.dataset.src = DIR + filename;
    img.onerror = () => p.classList.add("hide");

    const tag = document.createElement("div");
    tag.className = "tag";
    tag.textContent = i;

    p.appendChild(img);
    p.appendChild(tag);
    pagesEl.appendChild(p);
  }

  const io = new IntersectionObserver(entries => {
    entries.forEach(e => {
      const img = e.target.querySelector("img");
      if (e.isIntersecting && img && !img.src) {
        img.src = img.dataset.src;
        io.unobserve(e.target);
      }
    });
  }, { rootMargin: "800px 0px" });

  document.querySelectorAll(".page").forEach(p => io.observe(p));

  let current = 1, zoom = 1;
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const go = document.getElementById("go");

  function setZoom(z) {
    zoom = clamp(z, 0.6, 2.5);
    document.documentElement.style.setProperty("--zoom", zoom);
  }

  function scrollToPage(n) {
    current = clamp(n, 1, TOTAL);
    go.value = current;
    const el = document.querySelector(`.page[data-page="${current}"]`);
    if (el) window.scrollTo({ top: el.offsetTop - 70, behavior: "smooth" });
  }

  document.getElementById("prev").onclick = () => scrollToPage(current - 1);
  document.getElementById("next").onclick = () => scrollToPage(current + 1);
  document.getElementById("zin").onclick = () => setZoom(zoom + 0.15);
  document.getElementById("zout").onclick = () => setZoom(zoom - 0.15);
  document.getElementById("fit").onclick = () => {
    const first = document.querySelector(".page img");
    if (!first || !first.naturalWidth) return setZoom(1);
    const need = pagesEl.clientWidth / first.naturalWidth;
    setZoom(need);
  };
  document.getElementById("mode").onclick = () =>
    document.body.classList.toggle("light");
  go.onchange = () => scrollToPage(parseInt(go.value || "1", 10));

  const spy = new IntersectionObserver(es => {
    es.forEach(e => {
      if (e.isIntersecting) {
        current = parseInt(e.target.dataset.page, 10);
        go.value = current;
      }
    });
  }, { rootMargin: "-40% 0px -55% 0px" });
  document.querySelectorAll(".page").forEach(p => spy.observe(p));

  window.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft") scrollToPage(current - 1);
    if (e.key === "ArrowRight") scrollToPage(current + 1);
    if (e.key === "+") setZoom(zoom + 0.15);
    if (e.key === "-") setZoom(zoom - 0.15);
    if (e.key.toLowerCase() === "f") document.getElementById("fit").click();
  });

  go.value = 1;
  setZoom(1);
})();
</script>
